-- Neutron Monitor V0.4 (cc:Tweaked) - Avaritia Neutron Pile
-- Drawer -> graphs (delta/sec + delta/min)
-- Keys: C pause/resume, Q quit

local DRAWER_NAME  = "functionalstorage:jungle_1_0"
local MONITOR_NAME = "monitor_11" -- nil for terminal
local ITEM_NAME    = "avaritia:neutron_pile"

local SEC_HISTORY = 60
local MIN_HISTORY = 60
local SAMPLE_SEC  = 1
local ZERO_PROD_SEC_LIMIT = 30

local CONTINUE = true

-- ========== Helpers ==========
local function clamp(v,a,b) if v<a then return a elseif v>b then return b else return v end end
local function nowSec() return os.epoch("utc")/1000 end
local function maxAbs(t)
  local m=0
  for i=1,#t do local v=math.abs(t[i]); if v>m then m=v end end
  return (m<1) and 1 or m
end
local function avg(t)
  if #t==0 then return 0 end
  local s=0; for i=1,#t do s=s+t[i] end
  return s/#t
end

-- ========== Peripherals ==========
local drawer = peripheral.wrap(DRAWER_NAME)
if not drawer then error("Drawer not found: "..DRAWER_NAME) end

local out
if MONITOR_NAME then
  out = peripheral.wrap(MONITOR_NAME)
  if not out then error("Monitor not found: "..MONITOR_NAME) end
  out.setTextScale(0.5)
else
  out = term
end

local function clear()
  out.setBackgroundColor(colors.black)
  out.setTextColor(colors.white)
  out.clear()
  out.setCursorPos(1,1)
end

-- Returns: matchCount, allCount, slotsUsed, slotsMax
local function getStats()
  local items = drawer.list()
  local match, all = 0, 0
  local used, maxSlot = 0, 1

  for slot,it in pairs(items) do
    if type(slot)=="number" and slot>maxSlot then maxSlot=slot end
    if it and it.name then
      used = used + 1
      all = all + (it.count or 0)
      if it.name == ITEM_NAME then
        match = match + (it.count or 0)
      end
    end
  end
  return match, all, used, maxSlot
end

-- ========== Graph ==========
local function drawGraph(x,y,w,h,series,title,titleColor)
  local m = maxAbs(series)

  out.setCursorPos(x,y)
  out.setTextColor(titleColor or colors.cyan)
  out.write((title):sub(1,w) .. string.rep(" ", math.max(0, w-#title)))

  local top = y+1
  local bottom = y+h
  out.setTextColor(colors.gray)
  for row=top,bottom do
    out.setCursorPos(x,row)
    out.write(string.rep(" ", w))
  end

  local zeroRow = top + math.floor((h-1)/2)
  out.setCursorPos(x, zeroRow)
  out.write(string.rep("-", w))

  local start = math.max(1, #series - w + 1)
  local col = 0
  for i=start,#series do
    col = col + 1
    local v = series[i]
    local norm = v / m
    local off = math.floor(norm * ((h-1)/2))
    local r = clamp(zeroRow - off, top, bottom)

    out.setCursorPos(x + col - 1, r)
    out.setTextColor(v>=0 and colors.lime or colors.red)
    out.write("|")
  end

  out.setTextColor(colors.lightGray)
  out.setCursorPos(x, bottom+1)
  local leg = ("scale +/- %d"):format(m)
  out.write(leg:sub(1,w) .. string.rep(" ", math.max(0, w-#leg)))
end

-- ========== Main ==========
local secSeries, minSeries = {}, {}
local lastCount = nil
local lastMinMark = nil
local minAccum = 0
local zeroProdSec = 0

local function handleKey(ev, key)
  if ev=="key" then
    if key==keys.c then CONTINUE = not CONTINUE end
    if key==keys.q then clear(); error("Stopped (q).") end
  end
end

clear()

while true do
  local t0 = nowSec()
  local count, allCount, usedSlots, maxSlot = getStats()

  if not lastCount then
    lastCount = count
    lastMinMark = t0
  end

  local delta = count - lastCount
  lastCount = count

  if CONTINUE then
    table.insert(secSeries, delta)
    if #secSeries > SEC_HISTORY then table.remove(secSeries,1) end
    minAccum = minAccum + delta
    if delta <= 0 then zeroProdSec = zeroProdSec + 1 else zeroProdSec = 0 end
  else
    table.insert(secSeries, 0)
    if #secSeries > SEC_HISTORY then table.remove(secSeries,1) end
    zeroProdSec = 0
  end

  local elapsed = t0 - lastMinMark
  if elapsed >= 60 then
    table.insert(minSeries, minAccum)
    if #minSeries > MIN_HISTORY then table.remove(minSeries,1) end
    minAccum = 0
    lastMinMark = lastMinMark + math.floor(elapsed/60)*60
  end

  local w,h = out.getSize()
  clear()

  out.setCursorPos(1,1)
  out.setTextColor(colors.white)
  out.write("NEUTRON PILE - DASHBOARD")

  out.setCursorPos(1,2)
  out.setTextColor(colors.lightGray)
  out.write(("Item: %s | Mode: %s"):format(ITEM_NAME, CONTINUE and "ON" or "PAUSE"):sub(1,w))

  out.setCursorPos(1,3)
  out.write(("Drawer qty: %d | Slots: %d/%d | All items: %d"):format(count, usedSlots, maxSlot, allCount):sub(1,w))

  out.setCursorPos(1,4)
  out.setTextColor(colors.white)
  out.write(("Delta/s: %+d | Buffer(min): %+d | Avg/min: %.2f"):format(delta, minAccum, avg(minSeries)):sub(1,w))

  out.setCursorPos(1,5)
  if zeroProdSec >= ZERO_PROD_SEC_LIMIT then
    out.setTextColor(colors.red)
    out.write("ALERTE: PRODUCTION NULLE (verifie route -> drawer / lock / bus ME)" :sub(1,w))
  else
    out.setTextColor(colors.lime)
    out.write("OK: production detectee (attends si tres lent)" :sub(1,w))
  end

  local graphTop = 7
  local graphHeight = math.floor((h - graphTop - 2)/2)
  if graphHeight < 4 then graphHeight = 4 end

  drawGraph(1, graphTop, w, graphHeight, secSeries, "GRAPH: Delta / SECOND", colors.cyan)
  drawGraph(1, graphTop + graphHeight + 2, w, graphHeight, minSeries, "GRAPH: Delta / MINUTE", colors.yellow)

  local timer = os.startTimer(SAMPLE_SEC)
  while true do
    local ev,p1 = os.pullEvent()
    if ev=="timer" and p1==timer then break end
    handleKey(ev,p1)
  end
end
